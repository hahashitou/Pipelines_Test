<h1 id="process-pos-sales-events">Process POS sales events</h1>
<h2 id="background">Background</h2>
<p>Best For You Organics Company (BFYOC) has started a pilot program to
allow their point of sale (POS) systems to send sales information
directly to the cloud. The hope is it will allow BFYOC to analyze and
respond to sales data from their stores much faster.</p>
<h2 id="challenge">Challenge</h2>
<p>First, create an Event Hubs namespace with default values in your
Azure Subscription, then create a new Event Hub in it <strong>with 32
partitions</strong>. Then identify and copy the following
information:</p>
<ul>
<li><p>A shared access key connection string with Send permissions from
the shared access policies of your Event Hubs <strong>namespace</strong>
(not the Event Hub in the namespace)</p></li>
<li><p>The Event Hub name that you created inside your Event Hubs
namespace</p></li>
</ul>
<p>With that information make a post call to the
<code>/team/registerEventHub</code> method of the <a
href="https://petstore.swagger.io/?url=https://serverlessohmanagementapi.trafficmanager.net/api/definition">OpenHack
API System</a></p>
<p>You will be required to post your team table number, the Event Hubs
shared access key connection string, and the Event Hub name.</p>
<p>This will trigger the POS system to start sending batches of UTF-8
encoded events with sales details into your Event Hub. Each batch will
contain multiple sales events in JSON format from the POS systems.</p>
<p>Here is an example sale event:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;header&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;salesNumber&quot;</span><span class="fu">:</span> <span class="st">&quot;0c423398-3c7c-0682-7519-4701c445ed7a&quot;</span><span class="fu">,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;dateTime&quot;</span><span class="fu">:</span> <span class="st">&quot;2019-09-11T06:04:43.6819622-07:00&quot;</span><span class="fu">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;locationId&quot;</span><span class="fu">:</span> <span class="st">&quot;00d8ea6f-935c-2cca-9bbc-f56b5a091621&quot;</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;locationName&quot;</span><span class="fu">:</span> <span class="st">&quot;Lorena&#39;s Ice Cream Parlor&quot;</span><span class="fu">,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;locationAddress&quot;</span><span class="fu">:</span> <span class="st">&quot;865 Olson Cape&quot;</span><span class="fu">,</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;locationPostcode&quot;</span><span class="fu">:</span> <span class="st">&quot;03030&quot;</span><span class="fu">,</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;totalCost&quot;</span><span class="fu">:</span> <span class="st">&quot;123.40&quot;</span><span class="fu">,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;totalTax&quot;</span><span class="fu">:</span> <span class="st">&quot;12.34&quot;</span><span class="fu">,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;receiptUrl&quot;</span><span class="fu">:</span> <span class="st">&quot;https://serverlessohsales.blob.core.windows.net/TheReceipt.pdf&quot;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;details&quot;</span><span class="fu">:</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="ot">[</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;productId&quot;</span><span class="fu">:</span> <span class="st">&quot;65ab124a-9b2c-4294-a52d-18839364ef15&quot;</span><span class="fu">,</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;quantity&quot;</span><span class="fu">:</span> <span class="st">&quot;10&quot;</span><span class="fu">,</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;unitCost&quot;</span><span class="fu">:</span> <span class="st">&quot;10.40&quot;</span><span class="fu">,</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;totalCost&quot;</span><span class="fu">:</span> <span class="st">&quot;104.00&quot;</span><span class="fu">,</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;totalTax&quot;</span><span class="fu">:</span> <span class="st">&quot;10.40&quot;</span><span class="fu">,</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;productName&quot;</span><span class="fu">:</span> <span class="st">&quot;Durian Durian&quot;</span><span class="fu">,</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;productDescription&quot;</span><span class="fu">:</span> <span class="st">&quot;Smells suspect but tastes... also suspect.&quot;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;productId&quot;</span><span class="fu">:</span> <span class="st">&quot;75542e38-563f-436f-adeb-f426f1dabb5c&quot;</span><span class="fu">,</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;quantity&quot;</span><span class="fu">:</span> <span class="st">&quot;1&quot;</span><span class="fu">,</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;unitCost&quot;</span><span class="fu">:</span> <span class="st">&quot;3.40&quot;</span><span class="fu">,</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;totalCost&quot;</span><span class="fu">:</span> <span class="st">&quot;3.40&quot;</span><span class="fu">,</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;totalTax&quot;</span><span class="fu">:</span> <span class="st">&quot;0.34&quot;</span><span class="fu">,</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;productName&quot;</span><span class="fu">:</span> <span class="st">&quot;Starfruit Explosion&quot;</span><span class="fu">,</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;productDescription&quot;</span><span class="fu">:</span> <span class="st">&quot;This starfruit ice cream is out of this world!&quot;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;productId&quot;</span><span class="fu">:</span> <span class="st">&quot;80bab959-ef8b-4ae3-8bf2-e876d77277b6&quot;</span><span class="fu">,</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;quantity&quot;</span><span class="fu">:</span> <span class="st">&quot;2&quot;</span><span class="fu">,</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;unitCost&quot;</span><span class="fu">:</span> <span class="st">&quot;8.00&quot;</span><span class="fu">,</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;totalCost&quot;</span><span class="fu">:</span> <span class="st">&quot;16.00&quot;</span><span class="fu">,</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;totalTax&quot;</span><span class="fu">:</span> <span class="st">&quot;1.60&quot;</span><span class="fu">,</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;productName&quot;</span><span class="fu">:</span> <span class="st">&quot;French Vanilla&quot;</span><span class="fu">,</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;productDescription&quot;</span><span class="fu">:</span> <span class="st">&quot;It&#39;s vanilla ice cream.&quot;</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<blockquote>
<p>Not every record will have a URL for the <code>receiptUrl</code>
property. Some records may have a <code>null</code> value.</p>
</blockquote>
<p>Your first challenge is to work as a team to implement a solution
with an Azure Function using either the Consumption or Premium plan
(Serverless) that receives these events from Event Hubs <strong>in
batches</strong>, loops through each of them (debatching), and then
saves <strong>one entry per sale event</strong> into the same database
from the previous challenge. Note: if using CosmosDB this can be in a
separate collection.</p>
<p>Your second challenge is to configure your Azure Functions solution
to have a maximum event count received per receive loop (maximum batch
size) of 64 and a prefetch count value of 256 when retrieving batches
from the Event Hub.</p>
<p>Once you have your solution working, make a post call to the
<code>/team/boost/:teamTableNumber</code> method of the <a
href="https://petstore.swagger.io/?url=https://serverlessohmanagementapi.trafficmanager.net/api/definition">OpenHack
API System</a> You will be required to post your team table number. This
will enable the system to start sending a larger number of events into
your Event Hub.</p>
<p>Your third and final challenge is to monitor your Azure Functions
solution and identify the maximum number of instances that your Azure
Functions scaled up to ‘behind the scenes’ after turning boost mode
on.</p>
<p><strong>Note: The Serverless Open Hack will automatically reset the
rate of events to the initial value 4 hours after your team turns on
boost mode. Simply make an additional post call to turn it back on if
need be.</strong></p>
<h2 id="success-criteria">Success Criteria</h2>
<ul>
<li><p>Demonstrate to your coach your implementation that debatches and
inserts those events from Event Hub into your database</p></li>
<li><p>Demonstrate to your coach that your processor is retrieving
messages with a maximum batch size of 64 and prefetch count of
256</p></li>
<li><p>Demonstrate how you tracked the number of instances that your
Azure Functions scaled up to</p></li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><p><a
href="https://docs.microsoft.com/azure/event-hubs/event-hubs-what-is-event-hubs">What
is Event Hubs?</a></p></li>
<li><p><a
href="https://docs.microsoft.com/azure/event-hubs/event-hubs-scalability">Scaling
with Event Hubs</a></p></li>
<li><p><a
href="https://docs.microsoft.com/azure/azure-functions/functions-bindings-event-hubs">Azure
Event Hubs bindings for Azure Functions</a></p></li>
<li><p><a
href="https://docs.microsoft.com/azure/azure-functions/functions-bindings-event-hubs#trigger---scaling">Functions
Event Hubs Trigger Scaling</a></p></li>
<li><p><a
href="https://docs.microsoft.com/azure/event-hubs/event-hubs-event-processor-host">Azure
Event Hubs Event Processor Host overview</a></p></li>
<li><p><a
href="https://blogs.msdn.microsoft.com/appserviceteam/2017/09/19/processing-100000-events-per-second-on-azure-functions/">Processing
100,000 Events Per Second on Azure Functions</a></p></li>
<li><p><a
href="https://docs.microsoft.com/azure/application-insights/app-insights-analytics-tour">A
tour of Analytics in Application Insights</a></p></li>
<li><p><a
href="https://docs.microsoft.com/azure/azure-functions/functions-scale">Azure
Functions scale and hosting</a></p></li>
</ul>
<h2 id="progress-diagram">Progress Diagram</h2>
<figure>
<img
src="https://serverlessoh.azureedge.net/public/process-pos-sales-event-progress-diagram.jpg"
alt="Process POS sales event progress diagram" />
<figcaption aria-hidden="true">Process POS sales event progress
diagram</figcaption>
</figure>
