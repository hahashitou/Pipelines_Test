<h1 id="challenge-3">Challenge 3</h1>
<h2
id="success-criteria-have-the-rating-api-functions-code-in-source-control">Success
Criteria: Have the rating API functions’ code in source control</h2>
<ol type="1">
<li>First of all you need to create the required functions locally in VS
Code. Refer to <a
href="https://microsoftapc-my.sharepoint.com/personal/dabhan_microsoft_com/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fdabhan%5Fmicrosoft%5Fcom%2FDocuments%2FAPIs">this
code</a> for your functions.</li>
</ol>
<h2
id="success-criteria-demonstrate-a-working-cicd-pipeline-for-your-teams-coaches">Success
Criteria: Demonstrate a working CI/CD pipeline for your team’s
coaches</h2>
<p>Before we create add continuous deloyment capablities, we need to
setup a storage where the rating data will be kept and updated. In this
example we’re gonna use CosmosDB.</p>
<p>To use Azure Cosmos DB in serverless mode, choose Serverless as the
Capacity mode when creating your account.</p>
<ol start="4" type="1">
<li><p>First, in VS Code make sure that <strong>databases</strong> is
selected in the Azure extension view</p>
<figure>
<img src="images/azure_extension_databases.jpg" alt="azure extension" />
<figcaption aria-hidden="true">azure extension</figcaption>
</figure></li>
<li><p>In VS Code, right-click on the subscription in which you want to
create the database</p>
<figure>
<img src="images/create_server.png" alt="create server" />
<figcaption aria-hidden="true">create server</figcaption>
</figure></li>
<li><p>Select the <strong>Core(SQL)</strong> database server and give it
a name</p></li>
<li><p>Select the capacity model <strong>Serverless</strong></p></li>
<li><p>Select - preferably - the same resource group and region you used
for your function earlier.</p></li>
</ol>
<p>It should take a minute or two for your cosmosDB instance to be
available</p>
<figure>
<img src="images/cosmosdb_in_vscode.png" alt="cosmosdb in vscode" />
<figcaption aria-hidden="true">cosmosdb in vscode</figcaption>
</figure>
<ol start="9" type="1">
<li><p>In VS Code, right-click your CosmosDB account and select
<strong>Create database…</strong> and provide the following information
at the prompts:</p>
<ul>
<li>Database name, e.g. my-db</li>
<li>Name of the collection, e.g. my-container</li>
<li>A partition key for the container e.g. <code>/id</code></li>
</ul>
<p>Select <strong>OK</strong> to create the database and the
container.</p></li>
<li><p>To continue make sure you registered the binding extensions by
running following command</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode ps"><code class="sourceCode postscript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dotnet <span class="kw">add</span> package Microsoft.Azure.WebJobs.Extensions.CosmosDB</span></code></pre></div></li>
<li><p>Now we need to connect the function to the newly created CosmosDB
account. Right-click on your CosmosDB account and select <strong>Copy
Connection String</strong></p>
<figure>
<img src="images/copy-connection-string.png"
alt="copy connection string" />
<figcaption aria-hidden="true">copy connection string</figcaption>
</figure></li>
<li><p>In VS Code hit <kbd>F1</kbd> to show the Palette and look for
<code>Azure Functions: Add New Setting</code></p></li>
<li><p>Select your subscription, select yoru function app, then enter a
new app setting name <code>CosmosDbConnectionString</code> and paste the
value you copied earlier from the CosmosDB account.</p>
<p>This creates a application setting named connection
CosmosDbConnectionString in your function app in Azure.</p></li>
<li><p>Now, you can download this setting to your local.settings.json
file. Press <kbd>F1</kbd> again to open the command palette, then search
for and run the command <strong>Azure Functions: Download Remote
Settings</strong></p></li>
<li><p>Choose your subscription and your function in the propmt and (if
asked) select <strong>Yes to all</strong> to overwrite the existing
local settings.</p></li>
<li><p>If you didn’t already, update the <code>.cs</code> file of your
<code>CreateRating</code> function by adding following paramater to the
<code>Run</code> method. So that the parameters of the <code>Run</code>
method looks like following after the update:</p></li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> async Task<span class="op">&lt;</span>IActionResult<span class="op">&gt;</span> <span class="fu">Run</span><span class="op">(</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="fu">HttpTrigger</span><span class="op">(</span>AuthorizationLevel<span class="op">.</span><span class="fu">Anonymous</span><span class="op">,</span> <span class="st">&quot;post&quot;</span><span class="op">,</span> Route <span class="op">=</span> <span class="kw">null</span><span class="op">)]</span> HttpRequest req<span class="op">,</span> <span class="op">[</span><span class="fu">CosmosDB</span><span class="op">(</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>            databaseName<span class="op">:</span> <span class="st">&quot;icecreamdb&quot;</span><span class="op">,</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>            collectionName<span class="op">:</span> <span class="st">&quot;rating&quot;</span><span class="op">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>            ConnectionStringSetting <span class="op">=</span> <span class="st">&quot;CosmosDBConnection&quot;</span><span class="op">)]</span>IAsyncCollector<span class="op">&lt;</span>RatingModel<span class="op">&gt;</span> icecreamRatingOut<span class="op">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        ILogger log <span class="op">)</span></span></code></pre></div>
<ol start="17" type="1">
<li><p>Add the same parameter to the <code>Run</code> methods of each of
your functions.</p></li>
<li><p>Once you have your code locally, we’ll push it from VS Code to a
git repo. You will need to create a repo that will be used for
continuous deployment. For example a <a
href="https://docs.github.com/en/get-started/quickstart/create-a-repo">GitHub
repo</a>.</p></li>
</ol>
<p>In the next steps we’ll connect our git repo to our function. Here
are two ways of achieving this:</p>
<h3 id="using-the-deployment-center">Using the Deployment Center</h3>
<ol start="4" type="1">
<li><p>In the Azure Portal navigate to your function app &gt;
<strong>Deploymnet Center</strong></p>
<figure>
<img src="images/deployment_center.png" alt="deployment center" />
<figcaption aria-hidden="true">deployment center</figcaption>
</figure></li>
<li><p>In the Deployment Center select a source for your code,
e.g. GitHub</p>
<figure>
<img src="images/select_source.png" alt="select source" />
<figcaption aria-hidden="true">select source</figcaption>
</figure></li>
<li><p>In the repo settings, select the GitHub repo you created earlier
and <strong>save</strong>.</p>
<figure>
<img src="images/repo_settings.png" alt="select repo" />
<figcaption aria-hidden="true">select repo</figcaption>
</figure>
<p>If the connecting between your function app and the GitHub repo is
set correctly (usually takes a few seconds), you’ll see the following
state in the Deployment Center</p>
<figure>
<img src="images/repo_connected.png" alt="repo connected" />
<figcaption aria-hidden="true">repo connected</figcaption>
</figure></li>
</ol>
<h3 id="using-azure-devops">Using Azure DevOps</h3>
<p><strong>Create the Ratings function app to finish the company's API
while implementing a CI/CD pipeline for the team to work
with</strong></p>
<ul>
<li><p>Put code in GitHub or Azure DevOps or other Git Sources</p></li>
<li><p>This is an example of Azure Devops, Create a quick Azure devops
tenant:</p></li>
</ul>
<p><a
href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/organization-management?view=azure-devops"
class="uri">https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/organization-management?view=azure-devops</a></p>
<ul>
<li>Once created you can use the Git repo in Azure Devops to host your
function app code</li>
</ul>
<p>You can git commit your code to the Azure DevOps Git.</p>
<figure>
<img src="./images/image11.png"
alt="Graphical user interface, text, application, email Description automatically generated" />
<figcaption aria-hidden="true">Graphical user interface, text,
application, email Description automatically generated</figcaption>
</figure>
<ul>
<li><p>Create your Deployment pipeline so that the code can be
automatically deployed through pipeline in Azure Functions.</p></li>
<li><p>Create and continuously deploy to an Azure Function App<br />
<a
href="https://docs.microsoft.com/en-us/learn/modules/deploy-azure-functions/4-deploy-azure-function"
class="uri">https://docs.microsoft.com/en-us/learn/modules/deploy-azure-functions/4-deploy-azure-function</a></p></li>
</ul>
<p>Depending on the language we pick up the right resource from the
Azure devops pipeline and create your CICD.</p>
<figure>
<img src="./images/image12.png" alt="image text" />
<figcaption aria-hidden="true">image text</figcaption>
</figure>
<figure>
<img src="./images/image13.png" alt="omage text" />
<figcaption aria-hidden="true">omage text</figcaption>
</figure>
<p>For .Net it would a simple pipeline for build by using the tasks
“Build project **for .NETCore and “Publish Artefact”’</p>
<figure>
<img src="./images/image14.png" alt="image text" />
<figcaption aria-hidden="true">image text</figcaption>
</figure>
<p>For Deploy- you can use the same build pipeline, or you can use
release pipeline separately. Using the <strong>“Deploy Azure Function
App”</strong> <img src="./images/image15.png" alt="image text" /></p>
<h2
id="success-criteria-provide-your-coach-the-three-endpoint-urls.-the-coach-should-be-able-to-make-a-call-to-each-of-the-endpoints-and-get-successful-results">Success
Criteria: Provide your coach the three endpoint URLs. The coach should
be able to make a call to each of the endpoints and get successful
results</h2>
<p>(This should be achieved with the next criteria). ## Sucess Criteria:
The coach should be able to use GetRating and GetRatings to query for
ratings that the coach creates with CreateRating</p>
<ol type="1">
<li><p>In the Azure portal navigate to each of your functions
(<code>CreateRating</code>, <code>GetRating</code>, and
<code>GetRatings</code>) and get the URL of teh function like we did
earlier.</p></li>
<li><p>In the Azure portal navigate to your <code>CreateRating</code>
function, to <strong>Code + Test</strong>.</p></li>
<li><p>Click on <strong>Test/Run</strong>, select the HTTP method
<code>POST</code>, and pass an input payload such as:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&quot;userId&quot;</span><span class="fu">:</span> <span class="st">&quot;cc20a6fb-a91f-4192-874d-132493685376&quot;</span><span class="fu">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&quot;productId&quot;</span><span class="fu">:</span> <span class="st">&quot;4c25613a-a3c2-4ef3-8e02-9c335eb23204&quot;</span><span class="fu">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&quot;locationName&quot;</span><span class="fu">:</span> <span class="st">&quot;Sample ice cream shop&quot;</span><span class="fu">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&quot;rating&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&quot;userNotes&quot;</span><span class="fu">:</span> <span class="st">&quot;I love the subtle notes of orange in this ice cream!&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>This should create a rating item in the database and return an output
payload that includes an <code>id</code>.</p>
<p>You could also use a tool such as Postman to send a POST request to
your function.</p></li>
<li><p>Use the returned <code>id</code> to send a GET request to the
<code>GetRating</code> function</p></li>
<li><p>Test the <code>GetRatings</code> function in a similar way, by
sending a GET request with a <code>userId</code> parameter.</p></li>
</ol>
<h2
id="success-criteria-the-endpoints-should-return-standard-http-status-codes.-for-example-404-when-items-are-not-found.">Success
Criteria: The endpoints should return standard HTTP status codes. For
example, 404 when items are not found.</h2>
<p>Examine the code shared above (<a
href="https://microsoftapc-my.sharepoint.com/personal/dabhan_microsoft_com/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fdabhan%5Fmicrosoft%5Fcom%2FDocuments%2FAPIs">here</a>
is the link again).</p>
<p>In the code of the functions: - the method
<code>OKObjectResult</code> returns the status code 200 -
<code>BadRequestResult</code> and <code>BadRequestObjectResult</code>
return 400.</p>
<p>Make sure that these methods are added as described in the sample
code.</p>
<h2 id="useful-notes">Useful Notes</h2>
<h3 id="devops-notes">DevOps Notes</h3>
<ul>
<li><p>The team can create an AzDo account using the credentials
provided by the Opgility portal</p></li>
<li><p>If using Azure DevOps for source code but you still want to
connect to it from the Functions deployment options, you need to
configure from an organization that your login is the owner of.
<strong>The deployment configuration will reference</strong> <a
href="https://docs.microsoft.com/azure/devops/organizations/accounts/create-organization?view=azure-devops"><strong>these
instructions</strong></a> for doing so.</p>
<ul>
<li>Linux app service plans do not have Kudu service available so
therefore cannot use this option for deployment configuration</li>
</ul></li>
<li><p>See <a
href="https://docs.microsoft.com/azure/azure-functions/functions-deployment-technologies#deployment-technology-availability">Deployment
technology availability</a> for available deployment options based on
App Service plan selections.</p></li>
<li><p>Mac and Linux users will want to either create a storage account
in Azure to connect their local dev environment to, or install Azurite
v2. <a href="https://github.com/mydiemho/blob-trigger-sample">Azurite v3
will not work</a>, while Windows users can use Storage
Emulator.</p></li>
</ul>
<h3 id="storage-notes">Storage Notes</h3>
<ul>
<li><p><strong>CosmosDb</strong></p>
<ul>
<li><p>Ensure the team discusses the partition key requirement of the
collection.</p></li>
<li><p>Using the id property of the binding will not work without the
use of the partition key property as well. The
<strong>GetRating</strong> function will require using the sql
query</p></li>
</ul></li>
</ul>
<p><strong>Additional Notes:</strong></p>
<ul>
<li><p>Make sure to test their <strong>CreateRating</strong> function
using the sample website provided in the challenge, this will ensure
they are accepting the correct JSON format as that’ll be used in later
challenges</p></li>
<li><p>Get them to use Consumption plan (real serverless)</p></li>
<li><p>When trying to install extensions and getting an error on "cannot
find dotnet-add", this is due to old version of .NET Core, installing
latest version of .NET should correct this.</p></li>
<li><p>For <strong>GetRatings</strong> putting <strong>userId</strong>
into route and using it in the SQLQuery parameter (instead of query
string which doesn't work)</p></li>
<li><p>Cosmos DB requires a partition key to be set when creating the
container. As a coach, have a conversation with the team about the <a
href="https://docs.microsoft.com/azure/cosmos-db/partitioning-overview#choose-partitionkey">choice
of a partition key</a>, and how the partition key may impact querying.
For example, potential partition keys for this challenge may
be <strong>userId or productId.</strong></p></li>
</ul>
<h3 id="challenge-3-responses">Challenge 3 Responses</h3>
<p>Read the challenge responses (list them from the coach’s deck)</p>
<ul>
<li>Have the rating API functions’ code in source control</li>
</ul>
<blockquote>
<p><em>Show them your Azure Devops Git screen, where you have pushed the
code</em></p>
</blockquote>
<ul>
<li>Demonstrate a working CI/CD pipeline for your team’s coaches</li>
</ul>
<blockquote>
<p><em>Show them the pipeline as we have done in the
challenge(json)</em></p>
</blockquote>
<ul>
<li><p>Provide your coach the three endpoint URLs. The coach should be
able to make a call to each of the endpoints and get successful
results</p></li>
<li><p>The coach should be able to use GetRating and GetRatings to query
for ratings that the coach creates with CreateRating<br />
<br />
<em>The URLs for function apis should work as you have coded
it.</em></p></li>
<li><p>The endpoints should return standard HTTP status codes. For
example, 404 when items are not found.</p></li>
</ul>
