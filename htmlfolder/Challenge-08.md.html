<h1 id="pubsub-and-network-integration">Pub/Sub and Network
Integration</h1>
<h2 id="background">Background</h2>
<p>Executives at Best For You Organics Company (BFYOC) have taken notice
of the success of the recently implemented solution to enable Point of
Sale (POS) terminals to send sales data to the cloud, and they want to
leverage this new data even more. They have started a pilot program to
update BFYOC POS terminals to randomly capture a PDF version of the
sales receipt in addition to the detailed transaction data. They would
like to save all the transaction data to their private storage in the
cloud for data archival and future analysis. Additionally, executives
are concerned about the potential for fraudulent transactions, and would
like to add additional rigor for transactions which exceed $100.</p>
<p>After learning of the executive’s high-level requirements, the cloud
architecture team has decided to implement a publisher/subscriber
(pub/sub) messaging technique to capture POS sales data which has a
receipt. They feel they can use a message filtering pattern to identify
sales data which has a total transaction cost greater than $100.
Additionally, because BFYOC is highly protective of customer and sales
data, they want to ensure all the data is safely stored within an Azure
storage account which is accessible only from services within, or
integrated with, BFYOC’s virtual network in Azure. The files stored in
blob storage are able to be used by other systems within BFYOC’s virtual
network, such as data analysis and fraud detection processes.</p>
<p>BFYOC has an existing virtual network containing at least two
subnets. They also have an Azure storage account configured to use Azure
Virtual Network service endpoints to restrict access from any source
except the two subnets within the virtual network. An Azure Virtual
Machine is available to be used as a jumpbox for viewing data from
services within the virtual network.</p>
<figure>
<img
src="https://serverlessoh.azureedge.net/public/pubsub-and-vnet-integration-virtual-network-diagram.png"
alt="Virtual Network with subnets and blob storage service endpoints" />
<figcaption aria-hidden="true">Virtual Network with subnets and blob
storage service endpoints</figcaption>
</figure>
<h2 id="challenge">Challenge</h2>
<p>Your first challenge is to modify the Azure Function used in the
previous challenge to send the specified receipt information to a
pub/sub messaging system, but only if there is a receipt. Using the POS
data sent via the Event Hub from the previous challenge, you can create
a new JSON document with a structure similar to the example below that
will be sent to your pub/sub messaging system.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;totalItems&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;totalCost&quot;</span><span class="fu">:</span> <span class="fl">123.40</span><span class="fu">,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;salesNumber&quot;</span><span class="fu">:</span> <span class="st">&quot;0c423398-3c7c-0682-7519-4701c445ed7a&quot;</span><span class="fu">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;salesDate&quot;</span><span class="fu">:</span> <span class="st">&quot;09/11/2019 06:04:43&quot;</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;storeLocation&quot;</span><span class="fu">:</span> <span class="st">&quot;00d8ea6f-935c-2cca-9bbc-f56b5a091621&quot;</span><span class="fu">,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;receiptUrl&quot;</span><span class="fu">:</span> <span class="st">&quot;https://serverlessohsales.blob.core.windows.net/TheReceipt.pdf&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Next, you will need to create a process(es) which is able to filter
based on the total cost in each message, and accomplish the following
tasks:</p>
<ol type="1">
<li><p>If the total cost is greater than or equal to $100:</p>
<ul>
<li>retrieve the PDF file of the receipt using the
<code>receiptUrl</code> value</li>
<li>base64 encode the PDF</li>
<li>create a JSON object which includes the receipt data, along with the
base64 encoded version of the receipt</li>
<li>save the JSON object with a unique name to the “receipts-high-value”
container within the provided Azure Storage account (accessible only
from the virtual network)</li>
</ul>
<p>The format for the saved data should be as follows:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Store&quot;</span><span class="fu">:</span> <span class="st">&quot;00d8ea6f-935c-2cca-9bbc-f56b5a091621&quot;</span><span class="fu">,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;SalesNumber&quot;</span><span class="fu">:</span> <span class="st">&quot;0c423398-3c7c-0682-7519-4701c445ed7a&quot;</span><span class="fu">,</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;TotalCost&quot;</span><span class="fu">:</span> <span class="fl">123.40</span><span class="fu">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Items&quot;</span><span class="fu">:</span> <span class="dv">8</span><span class="fu">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;SalesDate&quot;</span><span class="fu">:</span> <span class="st">&quot;09/11/2019 06:04:43&quot;</span><span class="fu">,</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;ReceiptImage&quot;</span><span class="fu">:</span><span class="st">&quot;V2VsY29tZSB0byBTZXJ2ZXJsZXNzIE9wZW5IYWNrIQ==&quot;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div></li>
<li><p>If the total cost is less than $100:</p>
<ul>
<li>create a JSON object which includes the receipt data</li>
<li>save the JSON object with a unique name to the “receipts” container
within the provided Azure Storage account (accessible only from the
provided virtual network)</li>
</ul>
<p>The format for the saved data should be as follows:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Store&quot;</span><span class="fu">:</span> <span class="st">&quot;00d8ea6f-935c-2cca-9bbc-f56b5a091621&quot;</span><span class="fu">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;SalesNumber&quot;</span><span class="fu">:</span> <span class="st">&quot;0c423398-3c7c-0682-7519-4701c445ed7a&quot;</span><span class="fu">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;TotalCost&quot;</span><span class="fu">:</span> <span class="fl">6.58</span><span class="fu">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;Items&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;SalesDate&quot;</span><span class="fu">:</span> <span class="st">&quot;09/02/2019 10:36:17&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div></li>
</ol>
<p>When determining how to perform the filtering of messages, it is
important to remember that BFYOC has built a distributed system which
may, over time, require additional processing streams. The cloud
architecture team wants to ensure the solution avoids filtering “in
code” by leveraging features of the selected messaging system.</p>
<blockquote>
<p>HINT: All receipts should be sent to the messaging system, regardless
of overall total cost.</p>
</blockquote>
<h2 id="success-criteria">Success Criteria</h2>
<ul>
<li>Demonstrate the Azure Function which publishes data to a pub/sub
messaging service.</li>
<li>Demonstrate the ability to filter messages to the appropriate
process based on the total cost of purchased items.</li>
<li>Demonstrate the ability to retrieve messages from the pub/sub
service and save JSON files with a unique name to the proper blob
storage container in the provided Azure Storage account (which uses
service endpoints).</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a
href="https://docs.microsoft.com/azure/architecture/patterns/claim-check">Claim-Check
Pattern</a></li>
<li><a
href="https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoints-overview">Azure
Virtual Network Service Endpoints</a></li>
<li><a
href="https://docs.microsoft.com/azure/azure-functions/functions-premium-plan#private-network-connectivity">Azure
Functions Premium plan (network connectivity)</a></li>
<li><a
href="https://docs.microsoft.com/azure/azure-functions/functions-bindings-expressions-patterns#create-guids">Azure
Functions binding expression patterns</a></li>
<li><a
href="https://docs.microsoft.com/azure/azure-functions/functions-triggers-bindings">Azure
Functions triggers and bindings concepts</a></li>
<li><a
href="https://docs.microsoft.com/sandbox/functions-recipes/triggers-bindings">Azure
Functions Recipes - Triggers and bindings</a></li>
<li><a
href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-queues-topics-subscriptions">Azure
Service Bus Queues, Topics and Subscriptions</a></li>
<li><a
href="https://docs.microsoft.com/azure/azure-functions/functions-bindings-service-bus">Azure
Service Bus bindings for Azure Functions</a></li>
<li><a
href="https://docs.microsoft.com/azure/service-bus-messaging/topic-filters">Azure
Service Bus Topics and Filters</a></li>
<li><a
href="https://docs.microsoft.com/azure/service-bus-messaging/service-bus-resource-manager-namespace-topic-with-rule">Create
a Service Bus namespace with topic, subscription, and rule using an
Azure Resource Manager template</a></li>
<li><a
href="https://docs.microsoft.com/cli/azure/servicebus/topic/subscription/rule?view=azure-cli-latest">Azure
CLI (Service Bus)</a></li>
<li><a
href="https://github.com/Azure/azure-service-bus/tree/master/samples">Azure
Service Bus Samples (GitHub)</a></li>
<li><a
href="https://github.com/paolosalvatori/ServiceBusExplorer">Service Bus
Explorer</a></li>
</ul>
<h2 id="progress-diagram">Progress Diagram</h2>
<figure>
<img
src="https://serverlessoh.azureedge.net/public/pubsub-and-vnet-integration-progress-diagram.jpg"
alt="Pub/Sub and VNet Integration Progress Diagram" />
<figcaption aria-hidden="true">Pub/Sub and VNet Integration Progress
Diagram</figcaption>
</figure>
